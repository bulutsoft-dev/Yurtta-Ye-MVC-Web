@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model List<YurttaYe.Core.Models.ViewModels.AdminUserViewModel>

@{
    ViewData["Title"] = "Kullanıcı Yönetimi";
    ViewData["BreadcrumbItems"] = new List<dynamic>
    {
        new { Text = "Kullanıcı Yönetimi", Icon = "fas fa-users", Url = (string?)null }
    };
    
    ViewData["PageActions"] = new List<dynamic>
    {
        new { 
            Type = "link", 
            Url = Url.Action("Create"), 
            Text = "Yeni Kullanıcı", 
            Icon = "fas fa-user-plus",
            Color = "blue-600",
            HoverColor = "blue-700"
        }
    };
}

@Html.AntiForgeryToken()

<!-- Success/Error Messages -->
@if (TempData["Success"] != null)
{
    <div class="mb-6 bg-green-50 border border-green-200 rounded-lg p-4 flex items-center">
        <i class="fas fa-check-circle text-green-500 mr-3"></i>
        <span class="text-green-800 font-medium">@TempData["Success"]</span>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex items-center">
        <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
        <span class="text-red-800 font-medium">@TempData["Error"]</span>
    </div>
}

<!-- Search and Stats -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
    <!-- Search Card -->
    <div class="lg:col-span-3 admin-card bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-search text-blue-500 mr-2"></i>
            Kullanıcı Ara
        </h3>
        <form asp-action="Index" method="get" class="flex items-center space-x-4">
            <div class="flex-1 relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-user text-gray-400"></i>
                </div>
                <input type="text" name="search" value="@ViewBag.SearchTerm" 
                       placeholder="Kullanıcı adı veya e-posta ile arayın..."
                       class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <button type="submit" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                <i class="fas fa-search mr-2"></i>
                Ara
            </button>
            @if (!string.IsNullOrEmpty(ViewBag.SearchTerm))
            {
                <a asp-action="Index" class="px-6 py-3 bg-gray-500 text-white font-medium rounded-lg hover:bg-gray-600 transition-colors flex items-center">
                    <i class="fas fa-times mr-2"></i>
                    Temizle
                </a>
            }
        </form>
    </div>
    
    <!-- Stats Card -->
    <div class="admin-card bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-blue-100 text-sm font-medium">Toplam Kullanıcı</p>
                <p class="text-4xl font-bold">@Model.Count</p>
            </div>
            <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center">
                <i class="fas fa-users text-2xl"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center text-sm text-blue-100">
            <div class="flex items-center mr-4">
                <i class="fas fa-user-shield mr-1"></i>
                <span>@Model.Count(u => u.Roles.Contains("Admin")) Admin</span>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="admin-card bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-list text-blue-500 mr-2"></i>
            Kullanıcı Listesi
        </h3>
    </div>
    
    <div class="overflow-x-auto">
        @if (Model.Any())
        {
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Kullanıcı</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">E-posta</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Telefon</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Rol</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Durum</th>
                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">İşlemler</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                    @foreach (var user in Model)
                    {
                        <tr class="hover:bg-gray-50 transition-colors duration-200" data-user-id="@user.Id">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                                        <span class="text-white font-semibold text-sm">@user.UserName.Substring(0, Math.Min(2, user.UserName.Length)).ToUpper()</span>
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold text-gray-900">@user.UserName</p>
                                        <p class="text-xs text-gray-500">ID: @user.Id.Substring(0, 8)...</p>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <i class="fas fa-envelope text-gray-400 mr-2"></i>
                                    <span class="text-sm text-gray-900">@user.Email</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                @if (!string.IsNullOrEmpty(user.PhoneNumber))
                                {
                                    <div class="flex items-center">
                                        <i class="fas fa-phone text-gray-400 mr-2"></i>
                                        <span class="text-sm text-gray-900">@user.PhoneNumber</span>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-sm text-gray-400">-</span>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                @if (user.Roles.Contains("Admin"))
                                {
                                    <span class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800 border border-purple-200">
                                        <i class="fas fa-shield-alt mr-1"></i>
                                        Admin
                                    </span>
                                }
                                else
                                {
                                    <span class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800 border border-gray-200">
                                        <i class="fas fa-user mr-1"></i>
                                        Kullanıcı
                                    </span>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                @if (user.EmailConfirmed)
                                {
                                    <span class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 border border-green-200">
                                        <i class="fas fa-check-circle mr-1"></i>
                                        Onaylı
                                    </span>
                                }
                                else
                                {
                                    <span class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 border border-yellow-200">
                                        <i class="fas fa-clock mr-1"></i>
                                        Beklemede
                                    </span>
                                }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center space-x-2">
                                    <a asp-action="Edit" asp-route-id="@user.Id" 
                                       class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Düzenle">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button onclick="toggleEmailConfirmed('@user.Id')" 
                                            class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors" 
                                            title="@(user.EmailConfirmed ? "Onayı Kaldır" : "Onayla")">
                                        <i class="fas @(user.EmailConfirmed ? "fa-times-circle" : "fa-check-circle")"></i>
                                    </button>
                                    <button onclick="deleteUser('@user.Id', '@user.UserName')" 
                                            class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Sil">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="text-center py-12">
                <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Henüz kullanıcı yok</h3>
                <p class="text-gray-500 mb-6">İlk kullanıcıyı ekleyerek başlayın</p>
                <a asp-action="Create" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-user-plus mr-2"></i>
                    Yeni Kullanıcı Ekle
                </a>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function deleteUser(id, name) {
            if (confirmAdminDelete(`"${name}" kullanıcısını silmek istediğinizden emin misiniz?`)) {
                fetch(`/Admin/AdminUser/Delete/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({ id: id })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAdminNotification(data.message, 'success');
                        document.querySelector(`[data-user-id="${id}"]`).remove();
                    } else {
                        showAdminNotification(data.message, 'error');
                    }
                })
                .catch(error => {
                    showAdminNotification('Kullanıcı silinirken bir hata oluştu!', 'error');
                });
            }
        }

        function toggleEmailConfirmed(id) {
            fetch(`/Admin/AdminUser/ToggleEmailConfirmed/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify({ id: id })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAdminNotification(data.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAdminNotification(data.message, 'error');
                }
            })
            .catch(error => {
                showAdminNotification('İşlem sırasında bir hata oluştu!', 'error');
            });
        }
    </script>
}
